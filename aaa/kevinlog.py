"""
==========
記錄時間： 2022-10-24 07:31:55
操作人ID： None
金額： -6528.00
單號： 62210240731543739972925
備註： 发起提现申请6528.00元
==========
記錄時間： 2022-10-24 07:31:35
操作人ID： None
金額： 3250.00
單號： 62210240713237227692698
備註： 您好，由于银行系统交易受限，暂时不能为您出款，请联系在线客服，谢谢！


==========
記錄時間： 2022-10-24 07:30:24
操作人ID： None
金額： 3264.00
單號： 62210240709379945910518
備註： 您好，系统繁忙 请稍后再提交取款申请 谢谢
==========
記錄時間： 2022-10-24 07:13:24
操作人ID： None
金額： -3250.00
單號： 62210240713237227692698
備註： 发起提现申请3250.00元


==========
記錄時間： 2022-10-24 07:09:46
操作人ID： None
金額： 3264.00
單號： 62210240703423317448316
備註： 您好,1小时内不可重复提交相同金额哦谢谢诶~
==========
記錄時間： 2022-10-24 07:09:38
操作人ID： None
金額： -3264.00
單號： 62210240709379945910518
備註： 发起提现申请3264.00元


==========
記錄時間： 2022-10-24 07:08:49
操作人ID： None
金額： 3264.00
單號： 62210240707465159109092
備註： 您好,1小时内不可重复提交相同金额哦谢谢诶~
==========
記錄時間： 2022-10-24 07:07:47
操作人ID： None
金額： -3264.00
單號： 62210240707465159109092
備註： 发起提现申请3264.00元
==========
{
    "IM": {
        "net_amount": "100.00",
        "valid_amount": "100.00",
        "rental_fee_rate": "1.00",
        "rental_fee_platform": "0.00"
    },
    "KT": {
        "net_amount": "100.00",
        "valid_amount": "100.00",
        "rental_fee_rate": "1.00",
        "rental_fee_platform": "0.00"
    }
}

{
    'BG': {
        'net_amount': '-53.0000',
        'valid_amount': '49415.0000',
        'rental_fee_rate': '0.01',
        'rental_fee_platform': '57.380000'
        },
    'total_valid_amount': Decimal('49415.00'),
    'total_net_amount': Decimal('-53.00')
}



TENANT /apps/spinach/envs/test loaded
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====H=====
H-遊戲場館： BG
H-場館費率： 0.015
H-玩家輸贏： -53.0000
H-場館費： 0
H-場館費總結： 0
H-平台輸贏： 53.0000
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： 2775.0000
K-平台輸贏： -2775.0000
K-場館費： 41.6250000
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： -1860.0000
K-平台輸贏： 1860.0000
K-場館費： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： -461.0000
K-平台輸贏： 461.0000
K-場館費： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： -1678.0000
K-平台輸贏： 1678.0000
K-場館費： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： 1952.0000
K-平台輸贏： -1952.0000
K-場館費： 29.2800000
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： 1011.0000
K-平台輸贏： -1011.0000
K-場館費： 15.1650000
=====K=====
K-遊戲場館： BG
K-場館費率： 0.015
K-玩家輸贏： -1792.0000
K-平台輸贏： 1792.0000
K-場館費： 0
K-結算資料： {'BG': {'net_amount': Decimal('53.00'), 'valid_amount': Decimal('49415.00'), 'rental_fee_rate': '1.500', 'rental_fee_platform': Decimal('86.06')}}
K-結算資料： {}
K-結算資料： {}
入庫資料(更新)： {'user_id': 2304, 'level_1_platform_rental_detail': {'BG': {'net_amount': Decimal('53.00'), 'valid_amount': Decimal('49415.00'), 'rental_fee_rate': '1.500', 'rental_fee_platform': Decimal('86.06')}}, 'level_2_platform_rental_detail': {}, 'level_3_platform_rental_detail': {}, 'level_1_bonus_weekly': 0, 'level_1_bonus_deposit': Decimal('48.75'), 'level_1_bonus_red_envelope': 0, 'level_1_bonus_ratio_change': 0, 'level_3_bonus_ratio_change': 0, 'level_2_bonus_deposit': 0, 'level_3_bonus_birthday': 0, 'level_3_bonus_weekly': 0, 'level_2_bonus_red_envelope': 0, 'level_3_bonus_user_job': 0, 'level_2_bonus_weekly': 0, 'level_3_bonus_deposit': 0, 'level_2_bonus_level_up': 0, 'level_1_bonus_user_job': 0, 'level_1_bonus_birthday': 0, 'level_2_bonus_user_job': 0, 'level_2_bonus_ratio_change': 0, 'level_2_bonus_birthday': 0, 'level_1_bonus_level_up': 0, 'level_3_bonus_level_up': 0, 'level_3_bonus_red_envelope': 0}
一級下線場館詳細： {}
一級下線場館詳細： {}
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}
場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('-53.00')}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2304, 'total_users': Decimal('14'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}




TENANT /apps/spinach/envs/test loaded
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====H=====
H-遊戲場館： BG
H-場館費率： 0.01
H-玩家輸贏： -53.0000
H-場館費： 0
H-場館費總結： 0
H-平台輸贏： 53.0000
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.01
K-玩家輸贏： -53.0000
K-平台輸贏： -53.0000
K-場館費： 0
K-結算資料： {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}
K-結算資料： {}
K-結算資料： {}
入庫資料(更新)： {'user_id': 2304, 'level_1_platform_rental_detail': {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}, 'level_2_platform_rental_detail': {}, 'level_3_platform_rental_detail': {}, 'level_3_bonus_user_job': 0, 'level_2_bonus_red_envelope': 0, 'level_1_bonus_birthday': 0, 'level_1_bonus_level_up': 0, 'level_2_bonus_birthday': 0, 'level_2_bonus_deposit': 0, 'level_3_bonus_deposit': 0, 'level_3_bonus_level_up': 0, 'level_1_bonus_red_envelope': 0, 'level_3_bonus_weekly': 0, 'level_1_bonus_ratio_change': 0, 'level_3_bonus_birthday': 0, 'level_1_bonus_user_job': 0, 'level_1_bonus_deposit': Decimal('48.75'), 'level_2_bonus_ratio_change': 0, 'level_3_bonus_red_envelope': 0, 'level_2_bonus_weekly': 0, 'level_2_bonus_level_up': 0, 'level_1_bonus_weekly': 0, 'level_2_bonus_user_job': 0, 'level_3_bonus_ratio_change': 0}
一級下線場館詳細： {}
一級下線場館詳細： {}
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}
場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('53.00')}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2304, 'total_users': Decimal('14'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}



TENANT /apps/spinach/envs/test loaded
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====H=====
H-遊戲場館： BG
H-場館費率： 0.01
H-玩家輸贏： -53.0000
H-場館費： 0
H-場館費總結： 0
H-平台輸贏： 53.0000
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.01
K-玩家輸贏： -53.0000
K-平台輸贏： -53.0000
K-場館費： 0
K-結算資料： {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}
K-結算資料： {}
K-結算資料： {}
入庫資料(更新)： {'user_id': 2304, 'level_1_platform_rental_detail': {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}, 'level_2_platform_rental_detail': {}, 'level_3_platform_rental_detail': {}, 'level_1_bonus_user_job': 0, 'level_3_bonus_user_job': 0, 'level_1_bonus_deposit': Decimal('48.75'), 'level_2_bonus_weekly': 0, 'level_3_bonus_birthday': 0, 'level_3_bonus_level_up': 0, 'level_2_bonus_deposit': 0, 'level_1_bonus_weekly': 0, 'level_1_bonus_red_envelope': 0, 'level_2_bonus_red_envelope': 0, 'level_2_bonus_level_up': 0, 'level_3_bonus_ratio_change': 0, 'level_3_bonus_red_envelope': 0, 'level_1_bonus_birthday': 0, 'level_2_bonus_user_job': 0, 'level_1_bonus_level_up': 0, 'level_1_bonus_ratio_change': 0, 'level_2_bonus_birthday': 0, 'level_3_bonus_weekly': 0, 'level_2_bonus_ratio_change': 0, 'level_3_bonus_deposit': 0}
一級下線場館詳細： {}
一級下線場館詳細： {}
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}
場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('53.00')}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2304, 'total_users': Decimal('14'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}


TENANT /apps/spinach/envs/test loaded
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====H=====
H-遊戲場館： BG
H-場館費率： 0.01
H-玩家輸贏： -53.0000
H-場館費： 0
H-場館費總結： 0
H-平台輸贏： 53.0000
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
H-場館費總結： 0
H-平台輸贏： 0
=====K=====
K-遊戲場館： BG
K-場館費率： 0.01
K-玩家輸贏： -53.0000
K-平台輸贏： -53.0000
K-場館費： 0
K-結算資料： {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}
K-結算資料： {}
K-結算資料： {}
入庫資料(更新)： {
    'user_id': 2304,
    'level_1_platform_rental_detail': {
        'BG': {
            'net_amount': Decimal('-53.0000'),
            'valid_amount': Decimal('49415.0000'),
            'rental_fee_rate': '1.00',
            'rental_fee_platform': Decimal('0')
        }
    },
}
一級下線場館詳細： {}
一級下線場館詳細： {}
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}
場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('53.00')}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2304, 'total_users': Decimal('14'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}


入庫資料(更新)： {'user_id': 2304, 'level_1_platform_rental_detail': {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}, 'level_2_platform_rental_detail': {}, 'level_3_platform_rental_detail': {}, 'level_1_bonus_ratio_change': 0, 'level_1_bonus_user_job': 0, 'level_1_bonus_red_envelope': 0, 'level_3_bonus_deposit': 0, 'level_1_bonus_birthday': 0, 'level_3_bonus_red_envelope': 0, 'level_2_bonus_birthday': 0, 'level_1_bonus_deposit': Decimal('48.75'), 'level_2_bonus_weekly': 0, 'level_2_bonus_level_up': 0, 'level_1_bonus_weekly': 0, 'level_3_bonus_weekly': 0, 'level_2_bonus_deposit': 0, 'level_2_bonus_user_job': 0, 'level_3_bonus_level_up': 0, 'level_3_bonus_ratio_change': 0, 'level_3_bonus_user_job': 0, 'level_3_bonus_birthday': 0, 'level_2_bonus_ratio_change': 0, 'level_2_bonus_red_envelope': 0, 'level_1_bonus_level_up': 0}
更新前： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '1.00', 'rental_fee_platform': '0'}}
更新後： {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}
入庫前： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '1.00', 'rental_fee_platform': '0'}}
一級下線場館詳細： {}
一級下線場館詳細： {}
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}
場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('53.00')}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2304, 'total_users': Decimal('14'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}



明細日期(created)： 2022-08-31 16:00:01
明細日期(date)： 2022-08-31 16:00:00
一級下線場館詳細： {}
明細日期(created)： 2022-08-30 16:00:01
明細日期(date)： 2022-08-30 16:00:00
一級下線場館詳細： {}
明細日期(created)： 2022-08-30 05:45:01
明細日期(date)： 2022-08-29 16:00:00
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}
場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('53.00')}
==========
場館費總結==> {
    'total_register_users': Decimal('0'),
    'total_first_deposit_users': Decimal('0'),
    'total_active_users': Decimal('0'),
    'total_active_new_users': Decimal('0'),
    'total_bonus_amount': Decimal('0.00'),
    'total_commission_amount': Decimal('0.00'),
    'total_np': Decimal('0.00'),
    'total_valid_np': Decimal('0.00'),
    'rental_fee': Decimal('0.00'),
    'user_id': 2304,
    'total_users': Decimal('14'),
    'fee_rate': Decimal('0.00'),
    'current_valid_np': Decimal('0.00'),
    'estimate_commission_amount': Decimal('0.00')
}


明細日期(created)： 2022-08-31 16:00:01
明細日期(date)： 2022-08-31 16:00:00
一級下線場館詳細： {}

明細日期(created)： 2022-08-30 16:00:01
明細日期(date)： 2022-08-30 16:00:00
一級下線場館詳細： {}

明細日期(created)： 2022-08-30 05:45:01
明細日期(date)： 2022-08-29 16:00:00
一級下線場館詳細： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}}

場館費明細==> {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '0.01', 'rental_fee_platform': '57.380000'}, 'total_valid_amount': Decimal('49415.00'), 'total_net_amount': Decimal('53.00')}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2304, 'total_users': Decimal('14'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}
app@api-6f449d6b6c-z2xt7:/apps/spinach$ vi spinach/cli/__init__.py
app@api-6f449d6b6c-z2xt7:/apps/spinach$ spinach jojo
TENANT /apps/spinach/envs/test loaded
場館費明細==> {'total_valid_amount': 0, 'total_net_amount': 0}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2332, 'total_users': Decimal('0'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}


=====
filters==> {'created_ge': datetime.datetime(2022, 8, 28, 16, 0, tzinfo=<UTC>), 'created_lt': datetime.datetime(2022, 8, 31, 16, 0, tzinfo=<UTC>), 'user_id_in': []}
報表日期(created)： 2022-11-23 12:47:44
報表日期(date)： 2022-08-28 16:00:00
入庫資料(更新)： {'user_id': 2304, 'level_1_platform_rental_detail': {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}, 'level_2_bonus_red_envelope': 0, 'level_2_bonus_weekly': 0, 'level_1_bonus_birthday': 0, 'level_3_bonus_ratio_change': 0, 'level_2_bonus_deposit': 0, 'level_2_bonus_level_up': 0, 'level_3_bonus_red_envelope': 0, 'level_2_bonus_ratio_change': 0, 'level_1_bonus_red_envelope': 0, 'level_1_bonus_ratio_change': 0, 'level_3_bonus_weekly': 0, 'level_3_bonus_user_job': 0, 'level_1_bonus_level_up': 0, 'level_3_bonus_level_up': 0, 'level_3_bonus_deposit': 0, 'level_3_bonus_birthday': 0, 'level_1_bonus_deposit': Decimal('48.75'), 'level_1_bonus_weekly': 0, 'level_2_bonus_user_job': 0, 'level_2_bonus_birthday': 0, 'level_1_bonus_user_job': 0}
更新前： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '1.00', 'rental_fee_platform': '0'}}
更新後： {'BG': {'net_amount': Decimal('-53.0000'), 'valid_amount': Decimal('49415.0000'), 'rental_fee_rate': '1.00', 'rental_fee_platform': Decimal('0')}}
入庫後： {'BG': {'net_amount': '-53.0000', 'valid_amount': '49415.0000', 'rental_fee_rate': '1.00', 'rental_fee_platform': '0'}}
場館費明細==> {'total_valid_amount': 0, 'total_net_amount': 0}
==========
場館費總結==> {'total_register_users': Decimal('0'), 'total_first_deposit_users': Decimal('0'), 'total_active_users': Decimal('0'), 'total_active_new_users': Decimal('0'), 'total_bonus_amount': Decimal('0.00'), 'total_commission_amount': Decimal('0.00'), 'total_np': Decimal('0.00'), 'total_valid_np': Decimal('0.00'), 'rental_fee': Decimal('0.00'), 'user_id': 2332, 'total_users': Decimal('0'), 'fee_rate': Decimal('0.00'), 'current_valid_np': Decimal('0.00'), 'estimate_commission_amount': Decimal('0.00')}
"""
if __name__ == '__main__':
    from decimal import Decimal
    define = Decimal('18')
    rate = define / 100
    print('==>', rate)
    print(rate*100)

@cli.command()
def jojo():
    from spinach.universal_agent.services import UniversalAgentStatDailyService, universal_agent_relations
    from spinach.games.models import UserBetPlatformTypeDaily
    from spinach.services import universal_agent_stat_dailys

    class T(UniversalAgentStatDailyService):
        def stat_daily(self, days=1) -> None:
            """全民代理日報"""
            start = Delorean(
                datetime=datetime.strptime("2022-08-29", '%Y-%m-%d'), timezone=LOCAL_TZ).start_of_day.astimezone(pytz.UTC)
            end = start + timedelta(days=3)
            filters = {'created_ge': start, 'created_lt': end}
            bonus_details: dict = self._c_bonus_detail(filters=filters)
            rental_details: dict = self._c_rental_detail(filters=filters)
            agent_ids = set([k for k in bonus_details.keys()] + [k for k in rental_details.keys()])
            for agent_id in agent_ids:
                data = {**rental_details.get(agent_id, {}), **bonus_details.get(agent_id, {})}
                report = self.first(date=filters['created_ge'], user_id=agent_id)
                if report:
                    self.update(report, **data)
                else:
                    self.create(date=filters['created_ge'], **data)

        def _get_level_rental_detail(self, agent_id, level, filters) -> dict:
            """等級場館費
            -> {
                  'IM': {'net_amount': ..., 'valid_amount': ..., 'rental_fee_rate': ..., 'rental_fee_platform': ...},
                  'LY': {...},
                  ...
                }
            -net_amount -> 平台輸贏
            """
            user_ids = universal_agent_relations.get_agent_relation_ids(agent_id, level)
            filters['user_id_in'] = user_ids
            where = self.to_filter(filters, assign_model=UserBetPlatformTypeDaily)
            bets = db.session.query(
                UserBetPlatformTypeDaily.platform,
                UserBetPlatformTypeDaily.valid_amount,
                UserBetPlatformTypeDaily.net_amount,
            ).filter(*where)
            platform_rental_detail = {}
            for bet in bets:
                rental_fee_rate = self.get_rental_fee_rate(bet.platform)  # 場館費率
                # rental_fee_rate = Decimal('0.01')
                rental_fee_platform = bet.net_amount * rental_fee_rate if bet.net_amount > 0 else Decimal(0)  # 場館費
                valid_amount = bet.valid_amount
                net_amount = bet.net_amount  # 玩家輸贏
                detail = platform_rental_detail.get(bet.platform)
                if not detail:
                    platform_rental_detail[bet.platform] = {
                        'net_amount': -net_amount, 'valid_amount': valid_amount,
                        'rental_fee_rate': f'{rental_fee_rate * 100}', 'rental_fee_platform': rental_fee_platform}
                else:
                    detail['net_amount'] = self.decimal(detail.get('net_amount') + (-net_amount))
                    detail['valid_amount'] = self.decimal(detail.get('valid_amount') + valid_amount)
                    detail['rental_fee_platform'] = detail.get('rental_fee_platform') + rental_fee_platform
            return platform_rental_detail

        # 測試顯示
        def c_platform_rental_total(self, *details):
            """計算場館費總和{'platformA': rentalA, 'platformB': rentalB, ...}
            detail = {'LY': {'net_amount': ..., 'valid_amount': ..., 'rental_fee_rate': ..., 'rental_fee_platform': ...},
                      'IM': {...},
                      'IG': {...}
                     }
            """
            total = dict()
            total_valid_amount = total_net_amount = 0
            for detail in details:
                for platform, rental in detail.items():
                    total_p: dict = total.get(platform, {})
                    na = self.decimal(rental.get('net_amount', 0))
                    va = self.decimal(rental.get('valid_amount', 0))
                    if total_p:
                        rental_fee = self.decimal(total_p.get('rental_fee_platform', 0)) + self.decimal(
                            rental.get('rental_fee_platform', 0))
                        total_p['net_amount'] = self.decimal(total_p.get('net_amount', 0)) + na
                        total_p['valid_amount'] = self.decimal(total_p.get('valid_amount', 0)) + va
                        total_p['rental_fee_platform'] = rental_fee
                        total[platform] = total_p
                    else:
                        total[platform] = rental
                    total_net_amount += na
                    total_valid_amount += va
            total['total_valid_amount'] = total_valid_amount
            total['total_net_amount'] = total_net_amount
            return total

    s = T()
    s.stat_daily()

    f = {"created_dr": "2022-08-27T16:00:00.000Z ~ 2022-08-31T15:59:59.999Z"}
    logs = universal_agent_stat_dailys.search(dict(f, user_id='2304'))
    rental_details = []
    for log in logs:
        log: universal_agent_stat_dailys.__model__
        rental_details.append(log.level_1_platform_rental_detail)
    data: dict = s.c_platform_rental_total(*rental_details)
    print('data==>', data)

